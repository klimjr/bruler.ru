# Bruler.ru

## Закрываем dev и test версии
php artisan up; php artisan down --secret=Bruler23


## Что в сессии
`promocode` - из корзины и из заказа
`isActive` - активирован ли промокод
`message` - сообщение о промокоде
`useBonus` - использовали ли бонусы
`bonus` - сколько бонусов использовали

## Job'ы
Запускаются на сервере через supervisor
```bash
nano /etc/supervisor/conf.d/prod-bruler-worker.conf
sudo service supervisor restart
```

- FetchCdekOrderInfo
- FetchDostavistaOrderInfo

## Кабинеты
https://lk.cdek.ru/ — СДЭК
https://dostavista.ru/cabinet/integration — Достависта
https://dostavista.ru/track - Достависта трек ???
https://app.wazzup24.com/ - Ватсап

## Документация
https://apidoc.cdek.ru/ - СДЭК API
https://pay.yandex.ru/docs/ru/custom/backend/merchant-api/ - Яндекс Пэй API
https://apitest.dostavista.ru/business-api/doc - Достависта API
https://wazzup24.ru/help/api-ru/ - Ватсап API


## Последовательность заказа
В зависимости от выбранного способа оплаты заказа попадает в соответствующий метод оплаты.
### Оплата картой (Tinkoff)
1. Уходит запрос на создание платежа на Тинькофф.
2. В случае успеха, возвращается URL на оплату.
3. После оплаты, возвращается на страницу заказа.
4. Вебхук с результатом платежа отправляется самим банком.
5. В вебхуке: 
   - обновляется статус заказа
   - получается трек номер заказа, если был СДЭК
   - если трек номер есть то отправляется сообщение в ватсап
   - отправляется письмо с подтверждением заказа

### Оплата долями (Dolyami)
Аналогично оплате картой

### Оплата Yandex Pay
до 3 пункта аналогично оплате картой, далее:
4. Если пользователь вернулся на страницу заказа:
   - обновляется статус заказа
   - получается трек номер заказа, если был СДЭК
   - если трек номер есть, то отправляется сообщение в ватсап
   - отправляется письмо с подтверждением заказа
5. Если пользователь не вернулся на страницу заказа, то каждые 3 секунды проверяется статус платежа. 
   В случае успеха:
   - обновляется статус заказа
   - получается трек номер заказа, если был СДЭК
   - если трек номер есть, то отправляется сообщение в ватсап
   - отправляется письмо с подтверждением заказа

